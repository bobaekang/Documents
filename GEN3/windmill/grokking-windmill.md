# Grokking windmill

This document is created as an effort to understand Gen3's client-side **windmill** applicaton.

## Relation to Gen3 services

**windmill** is makes requests to other Gen3 services to authenticate/authorize user, fetch data to display, and submit forms/files on user's behalf. It is thus useful to list 1) which services are available at which paths and 2) which pages on **windmill** makes requests to which services.

### Paths to services

Refer to [the "Gen3's Microservices" page on the official website](https://gen3.org/resources/developer/microservice/) for a more comprehensive list.

| service       | location                     | path (URL)                                       |
| ------------- | ---------------------------- | ------------------------------------------------ |
| **windmill**  | /                            | http://portal-service/                           |
| **sheepdog**  | /api/                        | http://sheepdog-service/                         |
| **peregrine** | /api/search/\*               | http://peregrine-service/*                       |
| -             | /api/v0/submission/graphql   | http://peregrine-service/v0/submission/graphql   |
| -             | /api/v0/submission/getschema | http://peregrine-service/v0/submission/getschema |
| **indexd**    | /index/                      | http://indexd-service/                           |
| **fence**     | /user/                       | http://fence-service/                            |
| -             | /gen3-authz                  | http://fence-service/user/anyaccess              |
| **guppy**     | /guppy/                      | http://guppy-service/                            |

### Calling other services

Listing which page on **windmill** makes requests to which services.

| service       | page                                 |
| ------------- | ------------------------------------ |
| **sheepdog**  | /submission/map                      |
| -             | /:project                            |
| **peregrine** | /                                    |
| -             | /query                               |
| -             | /submission                          |
| -             | /:project/search                     |
| **indexd**    | /submission/files                    |
| **fence**     | /identity                            |
| **guppy**     | /explorer (if `useGuppyForExplorer`) |

## Build process

**windmill** has an elaborate build process to fetch/generate necessary assets and scripts needed for compile/bundle the React application as an output. This process is handled by running a build script `/runWebpack.sh` with a couple of arguments.

Running `/runWebpack.sh` will go through the following steps:

1. Copy application `gitops.json` from `cdis-manifest` directory (`gitops_config()`)
2. `bash /custom/customize.sh`
   - Copies app-specific resources (icons, logos) in `/custom` to `/src`
3. `npm run schema`
   - Runs `node ./data/getSchema.js`
   - Write data dictionary (`/data/dictionary.json`)
     - downloaded from **peregrine** (\$HOSTNAME/api/v0/submission/\_dictionary/\_all)
   - Write schema files (`./data/schema.json` and `./data/schema.graphql`)
     - downloaded from **peregrine** (\$HOSTNAME/api/v0/submission/schema)
4. `npm run relay`
   - Runs `node ./data/gqlSetup.js` to generate queries `./gqlHelper.js`
   - Runs `relay-compiler` to write runtime relay query files (`*.graphql.js`) to `/src/**generated**/` and elsewhere
5. `npm run params`
   - Runs `node ./data/getText.js` to generate configuration parameters and write to `/src/params.js`
6. `npm run sanity-check`
   - Runs `node ./sanity-check.js` to sanity check on parmas/dictionary match
7. Compile/bundle React application using webpack

## Configurations

**windmill** has a number of configuration settings used to customize the client-side application. Most configuration values fall into one of the following two categories:

- Application-wise parameters
  - site metadata
  - feature flags (explorer, analysis, etc.)
  - page contents, navigation buttons, filter settings, logos and images, etc.
- Paths to external services and resources

### Data flow pipeline

In general, configuration values flow through the following pipeline for relevant React components to consume them: environment variable & `/src/params.js` -> `/src/localconf.js` -> `/src/configs.js` -> component

In other cases, components import values directly from `/src/params.js`. or `/src/localconf.js`.

Here are some details on each step:

- environment variables
  - defined in `runWebpack.sh` and `webpack.config.js` or relies on default values provided in `/src/localconf.js`
- `/src/params.js`
  - generated by `/data/getTexts.js`
    - `/data/getTexts.js` merges default configuration file `/data/config/default.json` and target application's `gitops.json` (from [cdis-manifest](https://github.com/uc-cdis/cdis-manifest))
- `/src/localconf.js`
  - defines and exports configuration variables, both original and derived
    - derived config variables are based on environmental variables and imported values from `/src/params.js`
- `/src/configs.js`
  - Re-exports all exported values from `/src/config.js` in addition to one more value: `headers` for HTTP headers

## How it works

### Key libraries

- `react` & `react-dom` for view layer
- `react-router-dom` for client-side routing
- `redux` for state management
  - `redux-thunk` for async actions
  - `redux-persist` for retaining certificate
- `relay` for data fetching
  - data from **peregrine** (\$HOSTNAME/api/v0/submission/graphql/)
- [`@gen3/ui-component`](https://github.com/uc-cdis/gen3-ui-component) for UI components
  - button, dropdown, chart components, filter components, etc.

### Initializing

Before the root React component `<App />` renders the application, the following initializing steps are taken:

1. Initialize Google Analytics
2. Dispatch the following Redux actions (imported from `/src/actions.js`):
   - `fetchSchema`
     - fetch schema (static asset; "/data/schema.json")
   - `fetchDictionary`
     - fetch dictionary from **sheepdog** (\$HOSTNAME/api/v0/submission/\_dictionary/\_all)
   - `fetchVersionInfo`
     - fetch version info from **sheepdog** (\$HOSTNAME/api/\_version)
   - `fetchUserAccess`
     - fetch user access from **arborist** (\$ARBORIST_URL/authz)
   - `fetchUserAuthMapping`
     - fetch user access mapping from **arborist** (\$ARBORIST_URL/authz/mapping)
3. Add Font Awesome icons to use

### Routes and components

> **Note**: `<Component />` denotes any React component named "Component". In particular, `<ReduxComponent />` denotes a [Redux "Container component"](https://redux.js.org/basics/usage-with-react#presentational-and-container-components) connects a React component `<Component />` to Redux store.

> **Note**: `<ProtectedContent />` is a HOC that checks the login status, calls `filter` function if provided, and then either 1) redirects (most likely) "/login," 2) renders component if `public`, 3) renders component with timeout (`ReduxAuthTimeoutPopup`) if authenticated, or 4) renders component if data is loaded.

> **Note**: `isEnabled('featurename')` (imported from `/src/helpers/featureFlags`) checks `config.featureFlages['featurename']` imported from `/src/params.js` at compile time or from `window.sessionStorage` at runtime to switch on/off a specific **windmill** feature at its given route.

List all components with details on each route focusing on

- /login
  - `<ProtectedContent />`:
    - public
    - filter: `store.dispatch(fetchLogin())`
      - updates `state.provider` if succeeds
    - component: `<ReduxLogin />`
      - on button click, go to login URL
- /
  - `<ProtectedContent />`
    - public: `indexPublic`
      - imported from `/src/localconf.js`
      - `true` by default
    - component: `<IndexPage />`
      - displays custom charts and cards per `components.index` params, imported from `/src/params.js` (generated)
      - data for charts fetched from **peregrine** if `indexPublic` is `true`
- /submission
  - `<ProtectedContent />`
    - component: `<HomePage />`
      - projects list and transactions fetched from **peregrine**
- /submission/files
  - `<ProtectedContent />`
  - component: `<ReduxMapFiles />`
    - unmapped files fetched from **indexd**
- /submission/map
  - `<ProtectedContent />`
    - component: `<ReduxMapDataModel />`
      - submit files to **sheepdog**
- /document
  - `<ProtectedContent />`
    - component: `<DocumentPage />`
      - _empty_
- /query
  - `<ProtectedContent />`
    - component: `<GraphQLQuery />`
      - send queries to **guppy** if `useGuppyForExplorer`
- /analysis
  - conditional on `isEnabled('analysis')`
  - `<ProtectedContent />`
    - component: `<Analysis />`
      - apps per `config.analysisTools` params imported from `/src/params.js` (generated)
      - app metadata from `analysisApps` imported from `/src/localconf.js`
- /analysis/:app
  - conditional on `isEnabled('analysis')`
  - `<ProtectedContent />`
    - component: `<ReduxAnalysisApp />`
      - send requests to "/job" as needed (i.e. app is "vaGWAS" or `default`)
- /identity
  - `<ProtectedContent />`
    - filter: `store.dispatch(fetchAccess())`
      - fetch user profile from **fence** (\$HOSTNAME/user/credientials/cdis/)
    - component: `<UserProfile />`
      - renamed from `<ReduxUserProfile />`
      - work with credentials (i.e. API key) from **fence** (\$HOSTNAME/user/credientials/cdis/)
- /indexing
  - `<ProtectedContent />`
    - component: `<Indexing />`
      - **fence**?
- /quiz
  - `<ProtectedContent />`
    - component: `<UserAgreementCert />`
- /DD(/:node)
  - `<ProtectedContent />`
    - public
    - component: `<DataDictionary />`
- /files
  - `<ProtectedContent />`
    - public: `explorerPublic`
      - imported from `/src/localconf.js`
      - `false` by default
    - component: `useGuppyForExplorer` ? `<GuppyDataExplorer/>` : `<ExplorerPage />`
      - imported from `/src/localconf.js`
      - `false` by default
      - `<GuppyDataExplorer />`
        - fetch data from **guppy**
      - `<ExplorerPage />`
- /files/\*
  - `<ProtectedContent />`
    - flter: `store.dispatch(fetchCoreMetadata(props.match.params[0]))`
    - component: `<CoreMetadataPage />`
- /workspace
  - `<ProtectedContent />`
    - component: `<Workspace />`
- /lw-workspace/ || /no-workspace-access/
  - meant for Jupyter Hub service
  - component: `<ErrorWorkspacePlaceholder/ />`
    - if Workspace is not enabled
- /:project
  - `<ProtectedContent />`
    - component: `<ProjectSubmission />`
      - renamed from `<ReduxProjectSubmission />`
      - submit file to **sheepdog** (\$HOSTNAME/api/v0/submission/)
- /:project/search
  - `<ProtectedContent />`
    - filter: `store.dispatch(submitSearchForm( ... ))` || `Promise.resolve('ok')`
    - component: `<ReduxQueryNode />`
      - send query to **peregrine** (\$HOSTNAME/api/v0/submission/graphql)
- /explorer
  - conditional on `isEnabled('explorer')`
  - `<ProtectedContent />`
    - public: `explorerPublic`
      - imported from `/src/localconf.js`
      - `false` by default
    - component: `useGuppyForExplorer` ? `<GuppyDataExplorer />` : `<DataExplorer />`
      - imported from `/src/localconf.js`
      - `false` by default
      - `<GuppyDataExplorer />`
        - fetch data from **guppy**
      - `<DataExplorer />`
- /privacy-policy
  - conditional on `components.privacyPolicy`
    - imported from `/src/params.js` (generated)
  - `<ReduxPrivacyPolicy />`
    - fetch privacy policy text from `components.privacyPolicy.file`
- /privacy-browser
  - `<ProtectedContent />`
    - public: `resourceBrowserPublic`
      - imported from `/src/localconf.js`
      - conditional on `config.resourceBrowser.public` imported from `/src/params.js` (generated)
    - component: `<ResourceBrowser />`

## Discussions

### Using **windmill** for PCDC

**windmill** is created and designed with certain use cases in mind. While it works out of the box for intended use cases, it can be challenging to extend the application to fit a custom use case.

The following table lists some pros and cons of adopting **windmill**:

| Pros                                                                                                                                            | Cons                                                                                                                                                                                 |
| ----------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| <ul><li>Application available out of the box</li><li>Maintained by a dedicated team</li><li>Ensured compatibility with other Gen3 services</ul> | <ul><li>Fixed aesthetics</li><li>Difficult to extend or add custom features</li><li>Custom data model may not be supported as needed</li><li> Unused features still bundled together |

#### Alternative 1: fully custom PCDC client-side app

Thanks to Gen3's microservice architecture, it is possible to build a custom client-side application for PCDC to replace **windmill** altogether. This option will give maximum control over all aspects of the app _at the expense of_ the nontrivial burden of in-house development and maintenance.

#### Alternative 2: forked and customized **windmill** for PCDC use case

One major source of the complexities of **windmill** is the application's need to support multiple (though similar) use cases. Forking and customizing **windmill** _could_ give PCDC the best of the both worlds--leveraging the work of the Gen3 team while tailoring the application for PCDC's unique use case.

A custom fork of **windmill** can result in a smaller and more manageable application. On the other hand, customizability is still somewhat limited to **windmill**'s original design and the burden of maintainabiltiy is still on the PCDC team.

### Adding new features via app

**windmill** allows us to add "app" components that will be made available on "/analysis" page. This offers one way to add custom features to the client-side application.
